<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.io.util &mdash; tardis</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/tardis_logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> tardis
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/quickstart.html">Quickstart for TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/grid/TardisGridTutorial.html">TARDIS Grid Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/est_and_conv/index.html">Estimators and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/spectrum/index.html">Spectrum Generation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Research with TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../research/index.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Team &amp; Credits</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../team_and_governance/index.html">Team and Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sponsors.html">Sponsors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CHANGELOG.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Development Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">tardis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../zreferences.html">TARDIS Papers and useful References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Outdated</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../outdated/index.html">Outdated Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>tardis.io.util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.io.util</h1><div class="highlight"><pre>
<span></span># Utility functions for the IO part of TARDIS

import os
import re
import logging

import pandas as pd
import numpy as np
import collections
from collections import OrderedDict

import requests
import yaml
from tqdm.auto import tqdm

from tardis import constants
from astropy import units as u

from tardis import __path__ as TARDIS_PATH

logger = logging.getLogger(__name__)


<div class="viewcode-block" id="get_internal_data_path"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.get_internal_data_path">[docs]</a>def get_internal_data_path(fname):
    &quot;&quot;&quot;
    Get internal data path of TARDIS

    Returns
    -------
    data_path : str
        internal data path of TARDIS
    &quot;&quot;&quot;
    return os.path.join(TARDIS_PATH[0], &quot;data&quot;, fname)</div>


<div class="viewcode-block" id="quantity_from_str"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.quantity_from_str">[docs]</a>def quantity_from_str(text):
    &quot;&quot;&quot;
    Convert a string to `astropy.units.Quantity`

    Parameters
    ----------
    text :
        The string to convert to `astropy.units.Quantity`

    Returns
    -------
    `astropy.units.Quantity`
    &quot;&quot;&quot;
    value_str, unit_str = text.split(None, 1)
    value = float(value_str)
    if unit_str.strip() == &quot;log_lsun&quot;:
        value = 10 ** (value + np.log10(constants.L_sun.cgs.value))
        unit_str = &quot;erg/s&quot;

    unit = u.Unit(unit_str)
    if unit == u.L_sun:
        return value * constants.L_sun

    return u.Quantity(value, unit_str)</div>


<div class="viewcode-block" id="MockRegexPattern"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.MockRegexPattern">[docs]</a>class MockRegexPattern(object):
    &quot;&quot;&quot;
    A mock class to be used in place of a compiled regular expression
    when a type check is needed instead of a regex match.

    Notes
    -----
    This is usually a lot slower than regex matching.
    &quot;&quot;&quot;

    def __init__(self, target_type):
        self.type = target_type

<div class="viewcode-block" id="MockRegexPattern.match"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.MockRegexPattern.match">[docs]</a>    def match(self, text):
        &quot;&quot;&quot;
        Parameters
        ----------
        text :
            A string to be passed to `target_type` for conversion.

        Returns
        -------
        bool
            Returns `True` if `text` can be converted to `target_type`,
            otherwise returns `False`
        &quot;&quot;&quot;
        try:
            self.type(text)
        except ValueError:
            return False
        return True</div></div>


<div class="viewcode-block" id="YAMLLoader"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.YAMLLoader">[docs]</a>class YAMLLoader(yaml.Loader):
    &quot;&quot;&quot;
    A custom YAML loader containing all the constructors required
    to properly parse the tardis configuration.
    &quot;&quot;&quot;

<div class="viewcode-block" id="YAMLLoader.construct_quantity"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.YAMLLoader.construct_quantity">[docs]</a>    def construct_quantity(self, node):
        &quot;&quot;&quot;
        A constructor for converting quantity-like YAML nodes to
        `astropy.units.Quantity` objects.

        Parameters
        ----------
        node :
            The YAML node to be constructed

        Returns
        -------
        `astropy.units.Quantity`

        &quot;&quot;&quot;
        data = self.construct_scalar(node)
        return quantity_from_str(data)</div>

<div class="viewcode-block" id="YAMLLoader.mapping_constructor"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.YAMLLoader.mapping_constructor">[docs]</a>    def mapping_constructor(self, node):
        return OrderedDict(self.construct_pairs(node))</div></div>


YAMLLoader.add_constructor(&quot;!quantity&quot;, YAMLLoader.construct_quantity)
YAMLLoader.add_implicit_resolver(
    &quot;!quantity&quot;, MockRegexPattern(quantity_from_str), None
)
YAMLLoader.add_implicit_resolver(
    &quot;tag:yaml.org,2002:float&quot;, MockRegexPattern(float), None
)
YAMLLoader.add_constructor(
    yaml.resolver.BaseResolver.DEFAULT_MAPPING_TAG,
    YAMLLoader.mapping_constructor,
)


<div class="viewcode-block" id="yaml_load_file"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.yaml_load_file">[docs]</a>def yaml_load_file(filename, loader=yaml.Loader):
    with open(filename) as stream:
        return yaml.load(stream, Loader=loader)</div>


<div class="viewcode-block" id="yaml_load_config_file"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.yaml_load_config_file">[docs]</a>def yaml_load_config_file(filename):
    return yaml_load_file(filename, YAMLLoader)</div>


<div class="viewcode-block" id="traverse_configs"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.traverse_configs">[docs]</a>def traverse_configs(base, other, func, *args):
    &quot;&quot;&quot;
    Recursively traverse a base dict or list along with another one
    calling `func` for leafs of both objects.

    Parameters
    ----------
    base :
        The object on which the traversing is done
    other :
        The object which is traversed along with `base`
    func :
        A function called for each leaf of `base` and the correspnding leaf of `other`
        Signature: `func(item1, item2, *args)`
    args :
        Arguments passed into `func`
    &quot;&quot;&quot;
    if isinstance(base, collections.Mapping):
        for k in base:
            traverse_configs(base[k], other[k], func, *args)
    elif (
        isinstance(base, collections.Iterable)
        and not isinstance(base, basestring)
        and not hasattr(base, &quot;shape&quot;)
    ):
        for val1, val2 in zip(base, other):
            traverse_configs(val1, val2, func, *args)
    else:
        func(base, other, *args)</div>


<div class="viewcode-block" id="assert_equality"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.assert_equality">[docs]</a>def assert_equality(item1, item2):
    assert type(item1) is type(item2)
    try:
        if hasattr(item1, &quot;unit&quot;):
            assert item1.unit == item2.unit
        assert np.allclose(item1, item2, atol=0.0)
    except (ValueError, TypeError):
        assert item1 == item2</div>


<div class="viewcode-block" id="check_equality"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.check_equality">[docs]</a>def check_equality(item1, item2):
    try:
        traverse_configs(item1, item2, assert_equality)
    except AssertionError:
        return False
    else:
        return True</div>


<div class="viewcode-block" id="HDFWriterMixin"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.HDFWriterMixin">[docs]</a>class HDFWriterMixin(object):
    def __new__(cls, *args, **kwargs):
        instance = super(HDFWriterMixin, cls).__new__(cls)
        instance.optional_hdf_properties = []
        instance.__init__(*args, **kwargs)
        return instance

<div class="viewcode-block" id="HDFWriterMixin.to_hdf_util"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.HDFWriterMixin.to_hdf_util">[docs]</a>    @staticmethod
    def to_hdf_util(
        path_or_buf, path, elements, overwrite, complevel=9, complib=&quot;blosc&quot;
    ):
        &quot;&quot;&quot;
        A function to uniformly store TARDIS data to an HDF file.

        Scalars will be stored in a Series under path/scalars
        1D arrays will be stored under path/property_name as distinct Series
        2D arrays will be stored under path/property_name as distinct DataFrames

        Units will be stored as their CGS value

        Parameters
        ----------
        path_or_buf : str or pandas.io.pytables.HDFStore
            Path or buffer to the HDF file
        path : str
            Path inside the HDF file to store the `elements`
        elements : dict
            A dict of property names and their values to be
            stored.
        overwrite : bool
            If the HDF file path already exists, whether to overwrite it or not

        Notes
        -----
        `overwrite` option doesn&#39;t have any effect when `path_or_buf` is an
        HDFStore because the user decides on the mode in which they have
        opened the HDFStore (&#39;r&#39;, &#39;w&#39; or &#39;a&#39;).
        &quot;&quot;&quot;
        if (
            isinstance(path_or_buf, str)
            and os.path.exists(path_or_buf)
            and not overwrite
        ):
            raise FileExistsError(
                &quot;The specified HDF file already exists. If you still want &quot;
                &quot;to overwrite it, set function parameter overwrite=True&quot;
            )

        else:
            try:  # when path_or_buf is a str, the HDFStore should get created
                buf = pd.HDFStore(
                    path_or_buf, complevel=complevel, complib=complib
                )
            except TypeError as e:
                if e.message == &quot;Expected bytes, got HDFStore&quot;:
                    # when path_or_buf is an HDFStore buffer instead
                    logger.debug(
                        &quot;Expected bytes, got HDFStore. Changing path to HDF buffer&quot;
                    )
                    buf = path_or_buf
                else:
                    raise e

        if not buf.is_open:
            buf.open()

        scalars = {}
        for key, value in elements.items():
            if value is None:
                value = &quot;none&quot;
            if hasattr(value, &quot;cgs&quot;):
                value = value.cgs.value
            if np.isscalar(value):
                scalars[key] = value
            elif hasattr(value, &quot;shape&quot;):
                if value.ndim == 1:
                    # This try,except block is only for model.plasma.levels
                    try:
                        pd.Series(value).to_hdf(buf, os.path.join(path, key))
                    except NotImplementedError:
                        logger.debug(
                            &quot;Could not convert SERIES to HDF. Converting DATAFRAME to HDF&quot;
                        )
                        pd.DataFrame(value).to_hdf(buf, os.path.join(path, key))
                else:
                    pd.DataFrame(value).to_hdf(buf, os.path.join(path, key))
            else:  # value is a TARDIS object like model, runner or plasma
                try:
                    value.to_hdf(buf, path, name=key, overwrite=overwrite)
                except AttributeError:
                    logger.debug(
                        &quot;Could not convert VALUE to HDF. Converting DATA (Dataframe) to HDF&quot;
                    )
                    data = pd.DataFrame([value])
                    data.to_hdf(buf, os.path.join(path, key))

        if scalars:
            pd.Series(scalars).to_hdf(buf, os.path.join(path, &quot;scalars&quot;))

        if buf.is_open:
            buf.close()</div>

<div class="viewcode-block" id="HDFWriterMixin.get_properties"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.HDFWriterMixin.get_properties">[docs]</a>    def get_properties(self):
        data = {name: getattr(self, name) for name in self.full_hdf_properties}
        return data</div>

    @property
    def full_hdf_properties(self):
        if hasattr(self, &quot;virt_logging&quot;) and self.virt_logging:
            self.hdf_properties.extend(self.vpacket_hdf_properties)

        return self.optional_hdf_properties + self.hdf_properties

<div class="viewcode-block" id="HDFWriterMixin.convert_to_snake_case"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.HDFWriterMixin.convert_to_snake_case">[docs]</a>    @staticmethod
    def convert_to_snake_case(s):
        s1 = re.sub(&quot;(.)([A-Z][a-z]+)&quot;, r&quot;\1_\2&quot;, s)
        return re.sub(&quot;([a-z0-9])([A-Z])&quot;, r&quot;\1_\2&quot;, s1).lower()</div>

<div class="viewcode-block" id="HDFWriterMixin.to_hdf"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.HDFWriterMixin.to_hdf">[docs]</a>    def to_hdf(self, file_path_or_buf, path=&quot;&quot;, name=None, overwrite=False):
        &quot;&quot;&quot;
        Parameters
        ----------
        file_path_or_buf : str or pandas.io.pytables.HDFStore
            Path or buffer to the HDF file
        path : str
            Path inside the HDF file to store the `elements`
        name : str
            Group inside the HDF file to which the `elements` need to be saved
        overwrite : bool
            If the HDF file path already exists, whether to overwrite it or not
        &quot;&quot;&quot;
        if name is None:
            try:
                name = self.hdf_name
            except AttributeError:
                name = self.convert_to_snake_case(self.__class__.__name__)
                logger.debug(
                    f&quot;self.hdf_name not present, setting name to {name} for HDF&quot;
                )

        data = self.get_properties()
        buff_path = os.path.join(path, name)
        self.to_hdf_util(file_path_or_buf, buff_path, data, overwrite)</div></div>


<div class="viewcode-block" id="PlasmaWriterMixin"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.PlasmaWriterMixin">[docs]</a>class PlasmaWriterMixin(HDFWriterMixin):
<div class="viewcode-block" id="PlasmaWriterMixin.get_properties"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.PlasmaWriterMixin.get_properties">[docs]</a>    def get_properties(self):
        data = {}
        if self.collection:
            properties = [
                name
                for name in self.plasma_properties
                if isinstance(name, tuple(self.collection))
            ]
        else:
            properties = self.plasma_properties
        for prop in properties:
            for output in prop.outputs:
                data[output] = getattr(prop, output)
        data[&quot;atom_data_uuid&quot;] = self.atomic_data.uuid1
        if &quot;atomic_data&quot; in data:
            data.pop(&quot;atomic_data&quot;)
        if &quot;nlte_data&quot; in data:
            logger.warning(&quot;nlte_data can&#39;t be saved&quot;)
            data.pop(&quot;nlte_data&quot;)
        return data</div>

<div class="viewcode-block" id="PlasmaWriterMixin.to_hdf"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.PlasmaWriterMixin.to_hdf">[docs]</a>    def to_hdf(
        self,
        file_path_or_buf,
        path=&quot;&quot;,
        name=None,
        collection=None,
        overwrite=False,
    ):
        &quot;&quot;&quot;
        Parameters
        ----------
        file_path_or_buf : str or pandas.io.pytables.HDFStore
            Path or buffer to the HDF file
        path : str
            Path inside the HDF file to store the `elements`
        name : str
            Group inside the HDF file to which the `elements` need to be saved
        collection :
            `None` or a `PlasmaPropertyCollection` of which members are
            the property types which will be stored. If `None` then
            all types of properties will be stored. This acts like a filter,
            for example if a value of `property_collections.basic_inputs` is
            given, only those input parameters will be stored to the HDF file.
        overwrite : bool
            If the HDF file path already exists, whether to overwrite it or not
        &quot;&quot;&quot;
        self.collection = collection
        super(PlasmaWriterMixin, self).to_hdf(
            file_path_or_buf, path, name, overwrite
        )</div></div>


<div class="viewcode-block" id="download_from_url"><a class="viewcode-back" href="../../../api/tardis.io.util.html#tardis.io.util.download_from_url">[docs]</a>def download_from_url(url, dst):
    &quot;&quot;&quot;
    kindly used from https://gist.github.com/wy193777/0e2a4932e81afc6aa4c8f7a2984f34e2
    @param: url to download file
    @param: dst place to put the file
    &quot;&quot;&quot;

    file_size = int(requests.head(url).headers[&quot;Content-Length&quot;])
    if os.path.exists(dst):
        first_byte = os.path.getsize(dst)
    else:
        first_byte = 0
    if first_byte &gt;= file_size:
        return file_size
    header = {&quot;Range&quot;: &quot;bytes=%s-%s&quot; % (first_byte, file_size)}
    pbar = tqdm(
        total=file_size,
        initial=first_byte,
        unit=&quot;B&quot;,
        unit_scale=True,
        desc=url.split(&quot;/&quot;)[-1],
    )
    req = requests.get(url, headers=header, stream=True)
    with open(dst, &quot;ab&quot;) as f:
        for chunk in req.iter_content(chunk_size=1024):
            if chunk:
                f.write(chunk)
                pbar.update(1024)
    pbar.close()
    return file_size</div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2021, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 26 Sep 2021.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>